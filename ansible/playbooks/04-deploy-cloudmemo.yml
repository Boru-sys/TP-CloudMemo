- name: Deploy CloudMemo manifests (blue/green)
  hosts: controlplane
  become: true

  vars:
    workdir: /root/cloudmemo-k8s
    docker_image: "dindonheureux/cloudmemo:0.1.0"
    prenom: "elio"

  tasks:
    - name: Create workdir on control-plane
      file:
        path: "{{ workdir }}"
        state: directory
        mode: "0755"

    - name: Copy manifests to control-plane
      copy:
        src: /tp-cloudmemo/k8s/
        dest: "{{ workdir }}/"
        mode: "0644"

    - name: Replace placeholders in manifests (image + prenom)
      shell: |
        find {{ workdir }} -type f -name "*.yml" -print0 | xargs -0 sed -i \
          -e "s|YOUR_IMAGE|{{ docker_image }}|g" \
          -e "s|<prenom>|{{ prenom }}|g"
      args:
        executable: /bin/bash

    - name: Apply base manifests (namespaces)
      command: kubectl apply -f {{ workdir }}/base/
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Apply team-blue manifests
      command: kubectl apply -f {{ workdir }}/team-blue/
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Apply team-green manifests
      command: kubectl apply -f {{ workdir }}/team-green/
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Show status
      shell: |
        kubectl get pods -n team-blue
        echo "----"
        kubectl get pods -n team-green
        echo "----"
        kubectl get ingress -A
        echo "----"
        kubectl get pvc -A
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      args:
        executable: /bin/bash
      changed_when: false
